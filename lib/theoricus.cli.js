var __t;__t=function(ns){var curr,index,part,parts,_i,_len;curr=null,parts=[].concat=ns.split(".");for(index=_i=0,_len=parts.length;_i<_len;index=++_i){part=parts[index];if(curr===null){curr=eval(part);continue}curr[part]==null?curr=curr[part]={}:curr=curr[part]}return curr};var theoricus=exports.theoricus={};((function(){var __bind=function(a,b){return function(){return a.apply(b,arguments)}};__t("theoricus.commands").Server=function(){function g(a,b){this.the=a,this._handler=__bind(this._handler,this),this.port="11235",this.root=""+this.the.pwd+"/public",this.compiler=new theoricus.commands.Compiler(this.the,b),this.start_server()}var a,b,c,d,e,f;return c=require("http"),f=require("url"),b=require("fs"),d=require("path"),e=d.normalize,a=require("child_process").exec,g.prototype.start_server=function(){return this.server=c.createServer(this._handler).listen(this.port),console.log((""+"Server running at".bold+" http://localhost:"+this.port).grey)},g.prototype.close_server=function(){return this.server.close()},g.prototype._handler=function(a,c){var g,h,i,j,k,l=this;return j=a.headers,g=j["user-agent"],h=g.indexOf("Googlebot")>=0||g.indexOf("curl")>=0,k=f.parse(a.url).pathname,i=d.join(this.root,k),d.exists(i,function(f){var g,j,k;if(!f||b.lstatSync(i).isDirectory()){i=d.join(l.root,"/index.html"),j=b.readFileSync(i,"utf-8"),c.writeHead(200,{"Content-Type":"text/html"}),h===!0?(g=e(""+l.root+"/static/"+a.url+"/index.html"),d.existsSync(g)?(k=b.readFileSync(g),c.writeHead(200,{"Content-Type":"text/html"}),c.write(""+k+"\n"),c.end()):console.log("TODO: implement on-demmand cache")):(c.write(j),c.end());return}return b.readFile(i,"binary",function(a,b){var d;if(a){c.writeHead(500,{"Content-Type":"text/plain"}),c.write(a+"\n"),c.end();return}return i.match(/.js$/m)?c.writeHead(200,{"Content-Type":"text/javascript"}):(d=i.match(/(jpg|png|gif)$/m))?c.writeHead(200,{"Content-Type":"image/"+d[1]}):i.match(/.css$/m)&&c.writeHead(200,{"Content-Type":"text/css"}),c.write(b,"binary"),c.end()})})},g}(),__t("theoricus.crawler").Crawler=function(){function b(b){var c=this;a.create(function(a){return c.ph=a,c.ph.createPage(function(a){return c.page=a,typeof b=="function"?b():void 0})})}var a;return a=require("phantom"),b.prototype.page=null,b.prototype.get_src=function(a,b){var c=this;return this.page.open(a,function(){return c.keep_on_checking(b)})},b.prototype.keep_on_checking=function(a){var b=this;return this.page.evaluate(function(){return[window.crawler.is_rendered,document.all[0].outerHTML]},function(c){var d,e;return d=c[0],e=c[1],d?a(e):setTimeout(function(){return b.keep_on_checking(a)},10)})},b.prototype.exit=function(){return this.ph.exit()},b}(),__t("theoricus.commands").Add=function(){function a(a,b){var c;this.the=a,c=b[1];switch(c){case"model":new theoricus.generators.Model(this.the,b);break;case"view":new theoricus.generators.View(this.the,b);break;case"controller":new theoricus.generators.Controller(this.the,b);break;case"mvc":new theoricus.generators.Model(this.the,b),new theoricus.generators.Controller(this.the,b),new theoricus.generators.View(this.the,b);break;default:console.log("ERROR: Valid options: controller,model,view,mvc.")}}return a}(),__t("theoricus.commands").AddProject=function(){function d(d,e){var f,g=this;this.the=d,this.options=e,this.pwd=this.the.pwd,this.root=this.the.root,this.app_skel=c(""+this.root+"/cli/src/generators/templates/app_skel"),this.target=c(""+this.pwd+"/"+this.options[1]);if(b.existsSync(this.target)){console.log("ERROR".bold.red+" Target directory already existis."+("\n\t"+this.target).yellow);return}f="cp -r "+this.app_skel+" "+this.target,a(f,function(b,c,d){return b!=null?console.log(b):a("find "+g.target,function(a,b,c){var d,e,f,g,h;e=b.split("\n").slice(0,-1),h=[];for(f=0,g=e.length;f<g;f++)d=e[f],h.push(console.log((""+"Created".bold+" "+d).green));return h})})}var a,b,c;return b=require("path"),c=b.normalize,a=require("child_process").exec,d}(),__t("theoricus.commands").Compiler=function(){function h(a,d){var e,f;this.the=a,this._on_jade_stylus_change=__bind(this._on_jade_stylus_change,this),this.BASE_DIR=this.the.pwd,this.APP_FOLDER=""+this.BASE_DIR+"/app",e={folders:{},vendors:[""+this.the.root+"/www/vendors/jquery.js",""+this.the.root+"/www/vendors/history.js",""+this.the.root+"/www/vendors/history.adapter.native.js",""+this.the.root+"/www/vendors/jade.runtime.js"],release:"public/app.js",debug:"public/app-debug.js"},e.folders[this.APP_FOLDER]="app",e.folders[""+this.the.root+"/www/src"]="theoricus",this.toaster=new c(this.BASE_DIR,{w:1,d:1,config:e},!0),this.compile(),f=/.jade|.stylus$/,b.watch_folder(""+this.APP_FOLDER+"/static",f,this._on_jade_stylus_change)}var a,b,c,d,e,f,g;return f=require("path"),d=require("fs"),e=require("jade"),g=require("stylus"),c=require("coffee-toaster").Toaster,b=require("coffee-toaster").toaster.utils.FsUtil,a=require("coffee-toaster").toaster.utils.ArrayUtil,h.prototype.BASE_DIR="",h.prototype.APP_FOLDER="",h.prototype._on_jade_stylus_change=function(a){var b,c;if(a.action==="watching")return;if(a.type==="folder"&&a.action==="created")return;switch(a.action){case"created":b="New file created".bold.cyan,console.log(""+b+" "+a.path.green);break;case"deleted":c=a.type==="file"?"File":"Folder",b=(""+c+" deleted").bold.red,console.log(""+b+" "+a.path.red);break;case"updated":b="File changed".bold.cyan,console.log(""+b+" "+a.path.cyan)}return this.compile()},h.prototype.compile_jade=function(a){var c,f,g,h,i,j,k,l,m,n;h=b.find(""+this.APP_FOLDER+"/static",/.jade$/),k="(function() {\n\t__t('app').templates = { ~TEMPLATES };\n}).call( this );",c=[];for(m=0,n=h.length;m<n;m++){g=h[m];if(g.match(/(\_)?[^\/]+$/)[1]==="_")continue;j=g.match(/[^\/]+.jade$/m),i=g.match(/(static\/)(.*)$/m)[2].replace("/"+j,""),l=d.readFileSync(g,"utf-8"),f=e.compile(l,{filename:g,client:!0,compileDebug:!1}),f=f.toString().replace("anonymous",""),c.push("'"+i+"': "+f)}return k=k.replace("~TEMPLATES",c.join(",")),k=this.to_single_line(k),"// TEMPLATES\n"+k},h.prototype.compile_stylus=function(a){var c,e,f,h,i,j,k,l,m,n,o=this;f=b.find(""+this.APP_FOLDER+"/static",/.styl$/),c=[],this.pending_stylus=0;for(j=0,l=f.length;j<l;j++)e=f[j],e.match(/(\_)?[^\/]+$/)[1]!=="_"&&this.pending_stylus++;n=[];for(k=0,m=f.length;k<m;k++){e=f[k];if(e.match(/(\_)?[^\/]+$/)[1]==="_")continue;i=d.readFileSync(e,"utf-8"),h=[""+this.APP_FOLDER+"/static/_mixins/stylus"],n.push(g(i).set("filename",e).set("paths",h).render(function(b,d){if(b!=null)throw b;c.push(d);if(--o.pending_stylus===0)return a(c.join("\n"))}))}return n},h.prototype.compile=function(){var a,b,c,e,f=this;return a=this._get_config(),e=this.compile_jade(),c=""+e+"\n\n"+a.config+"\n\n"+a.routes+"\n\n"+a.root+"\n",b="new theoricus.Theoricus",this.toaster.build(c,b),this.compile_stylus(function(a){var b;return b=""+f.the.pwd+"/public/app.css",d.writeFileSync(b,a)})},h.prototype._get_config=function(){var a,b;return a=""+this.the.pwd+"/config/app.coffee",b=""+this.the.pwd+"/config/routes.coffee",a=d.readFileSync(a,"utf-8"),b=d.readFileSync(b,"utf-8"),new theoricus.commands.Config(a,b)},h.prototype.to_single_line=function(a){return theoricus.commands.Compiler.to_single_line(a)},h.to_single_line=function(a,b){return a.replace(/(^\/\/.*)|([\t\n]+)/gm,"")},h}(),__t("theoricus.commands").Config=function(){function Config(a,b){this._parse_app(a),this._parse_routes(b)}var Compiler,cs,fs;return Compiler=theoricus.commands.Compiler,fs=require("fs"),cs=require("coffee-script"),Config.prototype.config=null,Config.prototype.routes=null,Config.prototype.root=null,Config.prototype._parse_app=function(app){var tmp;try{tmp={},app=cs.compile(app.replace(/(^\w)/gm,"tmp.$1"),{bare:1}),eval(app)}catch(error){throw error}return this.config="// CONFIG\n"+Compiler.to_single_line("(function() {\n\t__t('app').config = {\n\t\tanimate_at_startup: "+tmp.animate_at_startup+",\n\t\tenable_auto_transitions: "+tmp.enable_auto_transitions+"\n\t};\n}).call( this );")},Config.prototype._parse_routes=function(routes){var buffer,root,tmp;buffer=[],root=null;try{tmp={root:function(a){return root=a},match:function(a,b){return a="'"+a+"': {\n\tto: '"+b.to+"',\n\tat: '"+b.at+"',\n\tel: '"+b.el+"'\n}",buffer.push(a.replace("'null'",null))}},routes=cs.compile(routes.replace(/(^\w)/gm,"tmp.$1"),{bare:1}),eval(routes)}catch(error){throw error}return this.root="// ROOT\n"+Compiler.to_single_line("(function() {\n\t__t('app').root = '"+root+"';\n\n}).call( this );",!0),this.routes="// ROUTES\n"+Compiler.to_single_line("(function() {\n\t__t('app').routes = {\n\t\t"+buffer.join(",")+"\n\t};\n}).call( this );",!0)},Config}(),__t("theoricus.commands").Index=function(){function e(a,c){var d=this;this.the=a,this.options=c,b("phantomjs -v",function(a,b,c){return/phantomjs: command not found/.test(c)?console.log("Error ".bold.red+("Install "+"phantomjs".yellow)+" before indexing pages."+"\n\thttp://phantomjs.org/"):(d.server=new theoricus.commands.Server(d.the,d.options),console.log("Start indexing...".bold.green),d.crawler=new theoricus.crawler.Crawler(function(){return d.get_page("http://localhost:11235/")}))})}var a,b,c,d;return c=require("fs"),b=require("child_process").exec,d=require("path"),a=require("coffee-toaster").toaster.utils.FsUtil,e.prototype.pages={},e.prototype.get_page=function(a){var b=this;return this.crawler.get_src(a,function(d){var e,f,g,h;b.get_links(a,d),b.save_page(a,d),b.pages[a]=!0,h=b.pages;for(a in h){e=h[a];if(!e)return b.get_page(a)}return f=""+b.the.pwd+"/public",g=""+b.the.pwd+"/public/static",c.writeFileSync(""+g+"/app.js",""),d=c.readFileSync(""+f+"/app.css","utf-8"),c.writeFileSync(""+g+"/app.css",d),console.log("Pages indexed successfully.".bold.green),b.crawler.exit(),b.server.close_server(),b.static_server=new theoricus.commands.StaticServer(b.the,b.options)})},e.prototype.get_links=function(a,b){var c,d,e,f;c=a.match(/(http:\/\/[\w]+:?[0-9]*)/g),e=/a\shref=(\"|\')(\/)?([^\'\"]+)/g,f=[];while((d=e.exec(b))!=null)a=""+c+"/"+d[3],this.pages[a]!==!0?f.push(this.pages[a]=!1):f.push(void 0);return f},e.prototype.save_page=function(b,e){var f,g,h;return h=/(http:\/\/)([\w]+)(:)?([0-9]+)?\/(.*)/g.exec(b)[5],g=d.normalize(""+this.the.pwd+"/public/static/"+h),d.existsSync(g)||a.mkdir_p(g),e=require("pretty-data").pd.xml(e)+"\n",c.writeFileSync(f=d.normalize(""+g+"/index.html"),e),h=(h||"/").bold.yellow,console.log("\t"+h.bold.yellow+" -> "+f)},e}(),__t("theoricus.commands").Rm=function(){function d(a,b){this.the=a,this.kind=b[1],this.name=b[2],this.APP_FOLDER=""+this.the.pwd+"/app";switch(this.kind){case"controller":this.rm_controller();break;case"model":this.rm_model();break;case"view":this.rm_view();break;case"mvc":this.rm_model(),this.rm_controller(),this.rm_view();break;default:console.log("ERROR: Valid options: controller,model,view,mvc.")}}var a,b,c;return b=require("fs"),c=require("path"),a=require("coffee-toaster").toaster.utils.FsUtil,d.prototype.rm_view=function(){var b,c,d,e,f,g,h,i,j;d=new RegExp(""+this.name+"-.*"),g=new RegExp("/"+this.name+"((/.*)|$)","m"),e=a.find(""+this.APP_FOLDER+"/static/",d,!0),f=a.find(""+this.APP_FOLDER+"/views",g,!0,!0),c=e.reverse().concat(f.reverse()),j=[];for(h=0,i=c.length;h<i;h++)b=c[h],j.push(this.rm(b));return j},d.prototype.rm_model=function(){return this.rm(""+this.APP_FOLDER+"/models/"+this.name+"_model.coffee")},d.prototype.rm_controller=function(){return this.rm(""+this.APP_FOLDER+"/controllers/"+this.name+"_controller.coffee")},d.prototype.rm=function(a){var d,e;e=a.match(/app\/.*/);if(c.existsSync(a)){try{b.lstatSync(a).isDirectory()?b.rmdirSync(a):(b.unlinkSync(a),d=!0)}catch(f){f.errno===-1&&console.log((""+"ERROR ".bold+" Not empty: "+e).yellow)}if(d)return console.log((""+"Removed ".bold+" "+e).green)}},d}(),__t("theoricus.commands").StaticServer=function(){function b(b,c){var d,e=this;this.the=b,this.port="11235",this.root=""+this.the.pwd+"/public/static",d=a.createServer({root:this.root,port:this.port,autoIndex:!0}),d.listen(this.port,"0.0.0.0",function(){var a;return a=(""+"Static server running at".bold+" http://localhost:"+e.port).grey,console.log(a)})}var a;return a=require("http-server"),b}(),__t("theoricus.generators").Controller=function(){function d(a,c){var d,e,f;this.the=a,f=c[2],e="app/controllers/"+f+"_controller.coffee",d=this.build_contents(f),b.writeFileSync(e,d),console.log((""+"Created: ".bold+" "+e).green)}var a,b,c;return b=require("fs"),a=require("coffee-toaster").toaster.utils.StringUtil,c={body:"class ~NAMEController extends app.controllers.AppController"},d.prototype.build_contents=function(b){var d;return d="",d+=c.body.replace("~NAME",a.ucasef(b))},d}(),__t("theoricus.generators").Model=function(){function d(a,c){var d,e,f;this.the=a,f=c[2],e="app/models/"+f+"_model.coffee",d=this.build_contents(f),b.writeFileSync(e,d),console.log((""+"Created: ".bold+" "+e).green)}var a,b,c;return b=require("fs"),a=require("coffee-toaster").toaster.utils.StringUtil,c={body:"class ~NAMEModel extends app.models.AppModel"},d.prototype.build_contents=function(b){var d;return d="",d+=c.body.replace("~NAME",a.ucasef(b))},d}(),__t("theoricus.generators").View=function(){function f(b,c){var e,f,g,h,i,j;this.the=b,f=c[2],j="app/views/"+f,g="app/static/"+f+"-index",i=""+j+"/index_view.coffee",e=""+g+"/markup.jade",h=""+g+"/style.styl",a.mkdir_p(j),a.mkdir_p(g),d.writeFileSync(i,this.build_contents("index")),console.log((""+"Created: ".bold+" "+i).green),d.writeFileSync(e,"// put your templates (JADE) here "),console.log((""+"Created: ".bold+" "+e).green),d.writeFileSync(h,"// put your styles (STYLUS) here"),console.log((""+"Created: ".bold+" "+h).green)}var a,b,c,d,e;return d=require("fs"),a=require("coffee-toaster").toaster.utils.FsUtil,b=require("coffee-toaster").toaster.utils.StringUtil,c=require("coffee-toaster").Toaster,e={body:"class ~NAMEView extends app.views.AppView"},f.prototype.build_contents=function(a){return e.body.replace("~NAME",b.ucasef(a))},f}(),exports.run=function(){return new theoricus.Theoricus},__t("theoricus").Theoricus=function(){function d(){var a,b,d;b=""+"model".cyan+"|".white+"view".cyan+"|".white+(""+"controller".cyan+"|".white+"all".cyan),this.header=""+"Theoricus".bold+" "+"v0.1.0\n  Blast navigable-MVC implementation for the browser.".grey+"\n\n",this.header+=""+"Usage:".bold+"\n",this.header+="  theoricus "+"new".red+"      "+"path".green+"\n",this.header+="  theoricus "+"add".red+"      "+b+" \n",this.header+="  theoricus "+"rm".red+"       "+b+" \n",this.header+="  theoricus "+"start".red+"    \n",this.header+="  theoricus "+"compile".red+"  \n",this.header+="  theoricus "+"index".red+"    \n\n",this.header+=""+"Options:".bold+"\n",this.header+="             "+"new".red+"   Creates a new working project in the file system.\n",this.header+="             "+"add".red+"   Generates a new model|view|controller file.\n",this.header+="              "+"rm".red+"   Destroy some model|view|controller file.\n",this.header+="           "+"start".red+"   Starts app in watch'n'compile mode at http://localhost:1123\n",this.header+="         "+"compile".red+"   Compile app to release destination.\n",this.header+="           "+"index".red+"   Index the whole application to a static non-js version.\n",this.header+="         "+"version".red+"   Show theoricus version.\n",this.header+="            "+"help".red+"   Show this help screen.\n",d=process.argv.slice(2),a=d.join(" ").match(/([a-z]+)/),a!=null&&(a=a[1]),this.root=c.normalize(__dirname+"/.."),this.app_root=this._get_app_root(),this.pwd=this.app_root||c.resolve(".");if(this.app_root===null&&a!=="help"&&a!=="new"){console.log("ERROR".bold.red+" Not a Theoricus app.");return}switch(a){case"new":new theoricus.commands.AddProject(this,d);break;case"add":new theoricus.commands.Add(this,d);break;case"rm":new theoricus.commands.Rm(this,d);break;case"start":new theoricus.commands.Server(this,d);break;case"static":new theoricus.commands.StaticServer(this,d);break;case"compile":new theoricus.commands.Compiler(this,d);break;case"index":new theoricus.commands.Index(this,d);break;case"version":console.log("vesion");break;default:console.log(this.header)}}var a,b,c;return b=require("fs"),c=require("path"),a=require("colors"),d.prototype._get_app_root=function(){var a,d,e,f;e=c.resolve(".");for(;;){a=c.normalize(""+e+"/app/controllers/app_controller.coffee");if(c.existsSync(a))return d=b.readFileSync(a,"utf-8"),d.indexOf("theoricus.mvc.Controller")>0?e:null;f=c.normalize(c.resolve(""+e+"/../"));if(e===f)return null;e=f;continue}},d}()})).call(this)